<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N'Farinati Modern Pizza - Menu & Delivery</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-main: #f4f6f8; 
            --bg-card: #ffffff; 
            --text-dark: #2a3324; 
            --text-muted: #6b7a5d; 
            --accent-main: #d32f2f; /* Rosso N'Farinati */
            --border-light: #e9ecef;
            --success: #28a745;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-main); color: var(--text-dark); padding-bottom: 120px; min-height: 100vh; }

        header { background: var(--bg-card); text-align: center; padding: 30px 20px 40px; border-bottom: 1px solid var(--border-light); box-shadow: 0 2px 15px rgba(0,0,0,0.03); }
        .logo-img { width: 170px; max-width: 100%; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);}
        header h2 { font-family: 'Montserrat', sans-serif; font-size: 1rem; color: var(--text-muted); margin-bottom: 20px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;}
        
        .restaurant-info { display: inline-block; background: var(--bg-main); border: 1px solid var(--border-light); padding: 15px 25px; border-radius: 12px; text-align: left; }
        .info-line { font-size: 0.85rem; color: var(--text-dark); margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-weight: 500;}
        .info-line:last-child { margin-bottom: 0; }
        .info-line i { color: var(--accent-main); width: 16px; text-align: center;}

        /* FILTRI */
        .filters-container { display: flex; overflow-x: auto; gap: 10px; padding: 15px 20px; position: sticky; top: 0; background: rgba(244, 246, 248, 0.98); backdrop-filter: blur(10px); z-index: 100; border-bottom: 1px solid var(--border-light); }
        .filters-container::-webkit-scrollbar { display: none; }
        .filter-btn { background: var(--bg-card); color: var(--text-dark); border: 1px solid var(--border-light); padding: 10px 20px; border-radius: 30px; font-weight: 600; font-size: 0.9rem; white-space: nowrap; cursor: pointer; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif;}
        .filter-btn.active { background: var(--accent-main); color: #ffffff; border-color: var(--accent-main); box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3); }
        
        .menu-container { padding: 0 15px; max-width: 900px; margin: 0 auto;}
        .category-section { animation: fadeIn 0.4s ease-in-out; display: block; }
        .category-section.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .category-title { font-family: 'Montserrat', sans-serif; padding: 25px 5px 10px; font-size: 1.6rem; font-weight: 900; color: var(--text-dark); text-transform: uppercase; border-bottom: 3px solid var(--accent-main); margin-bottom: 15px; display: inline-block;}
        
        /* CARD PRODOTTI */
        .menu-item { background-color: var(--bg-card); border: 1px solid var(--border-light); border-radius: 16px; padding: 18px; margin: 15px 0; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.03);}
        .item-placeholder-img { width: calc(100% + 36px); margin: -18px -18px 15px -18px; height: 180px; object-fit: cover; border-radius: 16px 16px 0 0; border-bottom: 1px solid var(--border-light);}
        
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .item-name { font-family: 'Montserrat', sans-serif; font-size: 1.15rem; font-weight: 800; color: var(--text-dark); line-height: 1.2; padding-right: 10px;}
        .item-price { font-family: 'Montserrat', sans-serif; font-size: 1.2rem; font-weight: 800; color: var(--accent-main); white-space: nowrap;}
        .item-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; margin-bottom: 15px; font-weight: 500; flex-grow: 1;}
        
        .controls { display: flex; align-items: center; justify-content: flex-end; margin-top: auto; padding-top: 15px; border-top: 1px dashed var(--border-light); }
        .qty-box { display: flex; align-items: center; gap: 15px; }
        
        .btn-control { background: #ffffff; color: var(--accent-main); border: 2px solid var(--border-light); border-radius: 8px; width: 36px; height: 36px; font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;}
        .btn-control:active { background: var(--accent-main); color: #ffffff; border-color: var(--accent-main);}
        .qty { font-weight: 700; font-size: 1.2rem; min-width: 25px; text-align: center; color: var(--text-dark);}
        
        /* VARIANTI IN CARRELLO */
        .variant-item { background: var(--bg-main); padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 4px solid var(--accent-main); border: 1px solid var(--border-light);}
        .variant-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; line-height: 1.4; font-weight: 600;}
        .variant-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; color: var(--text-dark); font-weight: 700; margin-bottom: 5px;}

        /* MODALE PERSONALIZZAZIONE STILE JUST EAT */
        .custom-section-title { font-family: 'Montserrat', sans-serif; font-weight: 800; color: var(--text-dark); margin: 25px 0 10px; font-size: 1.1rem; text-transform: uppercase; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--border-light); padding-bottom: 5px;}
        .badge-req { font-size: 0.65rem; background: var(--text-dark); color: #fff; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 700;}
        
        .custom-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        .custom-option-card { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; color: var(--text-dark); background: #ffffff; padding: 16px; border-radius: 12px; border: 1px solid var(--border-light); font-weight: 500; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.02); transition: all 0.2s;}
        .custom-option-card.selected { border-color: var(--accent-main); background: rgba(211, 47, 47, 0.03); }
        .custom-option-left { display: flex; align-items: center; width: 100%; cursor: pointer;}
        .custom-option-left input { margin-right: 15px; accent-color: var(--accent-main); transform: scale(1.4); }
        .custom-price { margin-left: auto; color: var(--accent-main); font-weight: 700; font-size: 0.95rem; }

        .allergens-box { margin: 40px 15px 20px; padding: 20px; background: var(--bg-card); border: 1px dashed var(--accent-main); border-radius: 12px; font-size: 0.8rem; color: var(--text-muted); line-height: 1.6; text-align: justify;}
        .allergens-box h4 { color: var(--accent-main); margin-bottom: 10px; font-size: 1rem; text-transform: uppercase; font-family: 'Montserrat', sans-serif; font-weight: 800;}

        /* CARRELLO FOOTER */
        .cart-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; padding: 15px 20px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 3px solid var(--accent-main); transform: translateY(120%); transition: transform 0.3s ease; z-index: 1000; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.15);}
        .cart-footer.visible { transform: translateY(0); }
        .cart-total { font-size: 1.4rem; font-weight: 800; color: var(--accent-main); font-family: 'Montserrat', sans-serif; display: flex; flex-direction: column;}
        .cart-total span { font-size: 0.75rem; color: var(--text-dark); text-transform: uppercase; margin-bottom: 2px; }
        
        /* STILI SCONTO */
        .old-price-strike { text-decoration: line-through; color: var(--text-muted); font-size: 0.95rem; font-weight: 600; margin-right: 8px;}
        .discount-badge { background: var(--success); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px; font-weight: 700;}
        
        .summary-breakdown { background: #f9f9f9; border: 1px solid var(--border-light); border-radius: 12px; padding: 15px; margin-bottom: 20px; margin-top: 15px;}
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; color: var(--text-dark); font-weight: 500;}
        .summary-line.discount-line { color: var(--success); font-weight: 700; }
        .summary-line.total-line { font-size: 1.25rem; font-weight: 800; color: var(--accent-main); border-top: 2px dashed var(--border-light); padding-top: 12px; margin-top: 8px; font-family: 'Montserrat', sans-serif;}

        .btn-checkout { background: var(--accent-main); color: #ffffff; border: none; padding: 14px 24px; border-radius: 50px; font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 8px; cursor: pointer; text-transform: uppercase; font-family: 'Montserrat', sans-serif; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);}

        /* MODALI */
        .checkout-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .checkout-modal.active { display: flex; }
        .checkout-content { background: var(--bg-main); border-radius: 16px; width: 100%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column;}
        
        .modal-header { padding: 20px 25px; background: #ffffff; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;}
        .modal-header h3 { font-family: 'Montserrat', sans-serif; color: var(--text-dark); margin: 0; font-weight: 900; font-size: 1.3rem; text-transform: uppercase;}
        .close-modal { color: var(--text-muted); font-size: 1.6rem; cursor: pointer; padding: 5px;}
        
        .modal-body { padding: 20px 25px; }

        .type-toggle { display: flex; gap: 10px; margin-bottom: 20px; background: #ffffff; padding: 5px; border-radius: 10px; border: 1px solid var(--border-light);}
        .type-toggle label { flex: 1; text-align: center; padding: 12px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; transition: 0.3s; text-transform: uppercase;}
        .type-toggle input[type="radio"] { display: none; }
        .type-toggle label.active { background: var(--accent-main); color: #fff; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-dark); margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 14px; border-radius: 8px; background: #ffffff; border: 1px solid var(--border-light); color: var(--text-dark); outline: none; font-size: 1rem; appearance: none; -webkit-appearance: none; font-family: 'Poppins', sans-serif; font-weight: 500;}
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent-main); box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);}
        
        .btn-confirm-order { width: 100%; background: var(--accent-main); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 1.1rem; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; text-transform: uppercase; font-family: 'Montserrat', sans-serif; transition: opacity 0.3s, background 0.3s;}
        .btn-confirm-order:disabled { background: #ced4da; cursor: not-allowed; color: #fff; box-shadow: none;}
        
        @media (min-width: 768px) {
            .filters-container { justify-content: center; flex-wrap: wrap; overflow-x: visible; padding: 20px; border-bottom: 1px solid var(--border-light); }
            .filter-btn { font-size: 1rem; padding: 10px 24px; }
            .menu-container { padding: 30px 20px; }
            .category-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .category-title { grid-column: span 2; text-align: center; margin-top: 20px; font-size: 2rem; }
            .menu-item { margin: 0; height: 100%; }
            .cart-footer { justify-content: center; gap: 50px; padding: 20px 0; }
            .allergens-box { grid-column: span 2; margin-top: 40px;}
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <img src="images/logo.jpg" alt="N'Farinati Logo" class="logo-img">
            <h2>MODERN PIZZA & BURGER</h2>
            
            <div class="restaurant-info">
                <div class="info-line"><i class="fa-solid fa-location-dot"></i> Via P. Togliatti 8, Bagheria (PA)</div>
                <div class="info-line"><i class="fa-solid fa-phone"></i> 091 8432674</div>
                <div class="info-line"><i class="fa-regular fa-clock"></i> Mar-Dom 18:30 - 23:30 (Luned√¨ Chiusi)</div>
            </div>
        </div>
    </header>

    <div class="filters-container" id="filters-container"></div>
    <div id="menu-container" class="menu-container"></div>

    <div class="cart-footer" id="cart-footer">
        <div class="cart-total">
            <span>Totale Ordine</span>
            <div id="total-price">0,00 ‚Ç¨</div>
        </div>
        <button class="btn-checkout" onclick="openCheckout()"><i class="fa-solid fa-cart-shopping"></i> Vai alla Cassa</button>
    </div>

    <div class="checkout-modal" id="checkout-modal" onclick="if(event.target === this) closeCheckout()">
        <div class="checkout-content">
            <div class="modal-header">
                <h3>Riepilogo Ordine</h3>
                <i class="fa-solid fa-xmark close-modal" onclick="closeCheckout()"></i>
            </div>
            
            <div class="modal-body">
                <div class="type-toggle">
                    <label id="lbl-takeaway" class="active">
                        <input type="radio" name="order-type" value="takeaway" checked onchange="toggleOrderType()">
                        üõçÔ∏è Asporto
                    </label>
                    <label id="lbl-delivery">
                        <input type="radio" name="order-type" value="delivery" onchange="toggleOrderType()">
                        üõµ Domicilio
                    </label>
                </div>

                <div class="form-group"><label>Nome e Cognome *</label><input type="text" id="cust-name" required></div>
                <div class="form-group"><label>Telefono *</label><input type="tel" id="cust-phone" required></div>
				
                <div class="form-group">
                    <label id="orario-label" for="orario-consegna">Orario di Ritiro *</label>
                    <select id="orario-consegna" name="orario" required></select>
                </div>

                <div id="delivery-fields" style="display: none;">
                    <div class="form-group">
                        <label>Indirizzo (Via, Civico, Info) *</label>
                        <input type="text" id="cust-address" placeholder="Es. Via Roma 10, Citofono Rossi">
                    </div>
                </div>

                <div class="form-group"><label>Note Aggiuntive per la cucina</label><textarea id="cust-notes" rows="2" placeholder="Es. Allergie, intolleranze..."></textarea></div>

                <div id="order-summary-breakdown" class="summary-breakdown"></div>

                <div class="form-group" style="background: #ffffff; padding: 15px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <label>Metodo di Pagamento *</label>
                    <select id="metodo-pagamento" name="metodo-pagamento" onchange="cambiaBottonePagamento()">
                        <option value="contanti">üíµ Contanti (alla consegna/ritiro)</option>
                        <option value="carta">üí≥ Carta di Credito (Nexi)</option>
                    </select>
                </div>
				
                <button class="btn-confirm-order" onclick="sendOrderWithDetails()" id="pay-btn" style="background: #28a745; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                    <i class="fa-solid fa-check-to-slot"></i> Conferma Ordine
                </button>
            </div>
        </div>
    </div>

    <div class="checkout-modal" id="custom-modal" onclick="if(event.target === this) closeCustomModal()">
        <div class="checkout-content">
            <div class="modal-header">
                <h3 id="custom-title">Personalizza</h3>
                <i class="fa-solid fa-xmark close-modal" onclick="closeCustomModal()"></i>
            </div>
            
            <div class="modal-body" id="custom-dynamic-sections"></div>
            
            <div style="padding: 20px; background: #ffffff; border-top: 1px solid var(--border-light); position: sticky; bottom: 0;">
                <button class="btn-confirm-order" onclick="addCustomItemToCart()" id="btn-add-custom" disabled>
                    <i class="fa-solid fa-triangle-exclamation"></i> Scegli le opzioni
                </button>
            </div>
        </div>
    </div>

<form id="nexi-form" method="POST" action="https://int-ecommerce.nexi.it/ecomm/ecomm/DispatcherServlet" style="display: none;">
    <input type="hidden" name="alias" id="nexi-alias">
    <input type="hidden" name="importo" id="nexi-importo">
    <input type="hidden" name="divisa" id="nexi-divisa">
    <input type="hidden" name="codTrans" id="nexi-codTrans">
    <input type="hidden" name="mac" id="nexi-mac">
    <input type="hidden" name="url" id="nexi-url">
    <input type="hidden" name="url_back" id="nexi-url-back">
</form>

    <script>
        const menuData = [
            {
                id: "pizze",
                category: "Pizze",
                items: [
                    { id: 1, categoryName: "Pizze", name: "Diavola", desc: "Personale / Familiare / Gluten free / Integrale", price: 7.50 },
                    { id: 2, categoryName: "Pizze", name: "Bianca", desc: "Personale / Familiare / Gluten free / Integrale", price: 5.50 },
                    { id: 3, categoryName: "Pizze", name: "San Francesco", desc: "Personale / Familiare / Gluten free / Integrale", price: 9.00 },
                    { id: 4, categoryName: "Pizze", name: "Orto Bio", desc: "Personale / Familiare / Integrale", price: 9.00 },
                    { id: 5, categoryName: "Pizze", name: "Eggplant Parmigiana", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.00 },
                    { id: 6, categoryName: "Pizze", name: "Naples", desc: "Personale / Familiare / Gluten free / Integrale", price: 6.50 },
                    { id: 7, categoryName: "Pizze", name: "Margherita 1983", desc: "Personale / Familiare / Gluten free / Integrale", price: 9.00 },
                    { id: 8, categoryName: "Pizze", name: "4 Cheese", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.00 },
                    { id: 9, categoryName: "Pizze", name: "La Quinta Margherita", desc: "Personale / Familiare / Gluten free / Integrale", price: 9.00 },
                    { id: 10, categoryName: "Pizze", name: "Aspra Mare", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.00 },
                    { id: 11, categoryName: "Pizze", name: "4 Gusti", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.00 },
                    { id: 12, categoryName: "Pizze", name: "Margherita classica", desc: "Personale / Familiare / Gluten free / Integrale", price: 6.00 },
                    { id: 13, categoryName: "Pizze", name: "Capricciosa", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.50 },
                    { id: 14, categoryName: "Pizze", name: "Marinara elegante D.O.P.", desc: "Personale / Gluten free / Integrale", price: 11.00 },
                    { id: 15, categoryName: "Pizze", name: "Parmigiana", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.00 },
                    { id: 16, categoryName: "Pizze", name: "Sfincione Modern Pizza", desc: "Personale / Familiare / Integrale", price: 9.00 },
                    { id: 17, categoryName: "Pizze", name: "Queen Margherita D.O.P.", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.50 },
                    { id: 18, categoryName: "Pizze", name: "Margherita 23", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.50 },
                    { id: 19, categoryName: "Pizze", name: "Veggy Pizza", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.50 },
                    { id: 20, categoryName: "Pizze", name: "Romana", desc: "Personale / Familiare / Gluten free / Integrale", price: 7.50 },
                    { id: 21, categoryName: "Pizze", name: "Patabom", desc: "Personale / Familiare / Integrale", price: 7.50 },
                    { id: 22, categoryName: "Pizze", name: "Bresa Hola Pizza", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 23, categoryName: "Pizze", name: "Don Calogero", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.00 },
                    { id: 24, categoryName: "Pizze", name: "Caprese Agro-Sarnese", desc: "Personale / Gluten free / Integrale", price: 12.00 }
                ]
            },
            {
                id: "pizze-americane",
                category: "Pizze Americane",
                items: [
                    { id: 25, categoryName: "Pizze Americane", name: "Cuzin Tano", desc: "Personale / Familiare / Integrale", price: 9.50 },
                    { id: 26, categoryName: "Pizze Americane", name: "Don Francisco Taco", desc: "Personale / Familiare / Integrale", price: 9.50 },
                    { id: 27, categoryName: "Pizze Americane", name: "Mango Habanero Chicken Pizza", desc: "Personale / Familiare", price: 11.50 },
                    { id: 28, categoryName: "Pizze Americane", name: "Buffalo Bill Chicken", desc: "Personale / Familiare / Integrale", price: 8.50 },
                    { id: 29, categoryName: "Pizze Americane", name: "Grandma NCY Pizza", desc: "Personale / Familiare / Gluten free / Integrale", price: 7.00 },
                    { id: 30, categoryName: "Pizze Americane", name: "BBQ Chicken", desc: "Personale / Familiare / Integrale", price: 8.50 },
                    { id: 31, categoryName: "Pizze Americane", name: "Chicken Parm", desc: "Personale / Familiare / Integrale", price: 8.50 },
                    { id: 32, categoryName: "Pizze Americane", name: "Sicilian in New Jersey", desc: "Personale / Familiare / Gluten free", price: 8.50 },
                    { id: 33, categoryName: "Pizze Americane", name: "Chicken & Pesto", desc: "Personale / Familiare / Integrale", price: 8.50 },
                    { id: 34, categoryName: "Pizze Americane", name: "Only Meat Lover", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 35, categoryName: "Pizze Americane", name: "Chicken Rancho", desc: "Personale / Familiare / Integrale", price: 9.50 },
                    { id: 36, categoryName: "Pizze Americane", name: "Heart Attack", desc: "Personale / Familiare / Integrale", price: 11.50 },
                    { id: 37, categoryName: "Pizze Americane", name: "Pizza Mania Original", desc: "Personale / Familiare / Integrale", price: 9.50 },
                    { id: 38, categoryName: "Pizze Americane", name: "Potato & Onion Deluxe", desc: "Personale / Familiare / Integrale", price: 9.00 },
                    { id: 39, categoryName: "Pizze Americane", name: "Greenfield", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 40, categoryName: "Pizze Americane", name: "Stuffed Meat Pizza Familiare Ripiena", desc: "", price: 25.00 },
                    { id: 41, categoryName: "Pizze Americane", name: "Chicken Caesar Crust", desc: "Personale / Familiare / Gluten free / Integrale", price: 8.50 },
                    { id: 42, categoryName: "Pizze Americane", name: "Tropical Hawaiian Only for Real Americans", desc: "Personale / Familiare / Integrale", price: 7.50 },
                    { id: 43, categoryName: "Pizze Americane", name: "Twenty Miles", desc: "Personale / Familiare / Integrale", price: 8.50 },
                    { id: 44, categoryName: "Pizze Americane", name: "Sweet Alabama", desc: "Personale / Familiare / Integrale", price: 9.50 },
                    { id: 45, categoryName: "Pizze Americane", name: "Las Vegas Nevada", desc: "Personale / Familiare / Integrale", price: 8.50 },
                    { id: 46, categoryName: "Pizze Americane", name: "Brooklyn Original", desc: "Personale / Familiare / Gluten free / Integrale", price: 7.00 },
                    { id: 47, categoryName: "Pizze Americane", name: "French Fries Pie", desc: "Personale / Familiare / Integrale", price: 8.50 },
                    { id: 48, categoryName: "Pizze Americane", name: "Cheese Steak and Bake", desc: "Personale / Familiare / Integrale", price: 11.00 },
                    { id: 49, categoryName: "Pizze Americane", name: "Chips Pizza", desc: "Personale / Familiare / Integrale", price: 9.50 }
                ]
            },
            {
                id: "pizze-gourmet",
                category: "Pizze Gourmet",
                items: [
                    { id: 50, categoryName: "Pizze Gourmet", name: "Bronx", desc: "Personale / Familiare / Integrale", price: 10.50 },
                    { id: 51, categoryName: "Pizze Gourmet", name: "Orton Zola", desc: "Personale / Familiare / Integrale", price: 9.50 },
                    { id: 52, categoryName: "Pizze Gourmet", name: "La Maria", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 53, categoryName: "Pizze Gourmet", name: "October Fest Pizza", desc: "Personale / Familiare / Integrale", price: 12.00 },
                    { id: 54, categoryName: "Pizze Gourmet", name: "Atlantic City Pizza", desc: "", price: 12.00 },
                    { id: 55, categoryName: "Pizze Gourmet", name: "Malcolm Ave", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 56, categoryName: "Pizze Gourmet", name: "Focarcina", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 57, categoryName: "Pizze Gourmet", name: "Raffinata", desc: "Personale / Familiare / Integrale", price: 11.00 },
                    { id: 58, categoryName: "Pizze Gourmet", name: "Romana Luxury", desc: "Personale / Integrale", price: 13.50 },
                    { id: 59, categoryName: "Pizze Gourmet", name: "Saint Thomas", desc: "Personale / Familiare / Integrale", price: 11.50 },
                    { id: 60, categoryName: "Pizze Gourmet", name: "Pumpkin Pizza", desc: "Personale / Familiare / Integrale", price: 9.00 },
                    { id: 61, categoryName: "Pizze Gourmet", name: "‚ÄôNfarinati Originale", desc: "Personale / Familiare / Gluten free / Integrale", price: 9.50 },
                    { id: 62, categoryName: "Pizze Gourmet", name: "Guancia-Tella", desc: "Personale / Integrale", price: 12.50 },
                    { id: 63, categoryName: "Pizze Gourmet", name: "Serenata", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.50 },
                    { id: 64, categoryName: "Pizze Gourmet", name: "South Beach", desc: "Personale / Familiare / Gluten free / Integrale", price: 12.00 },
                    { id: 65, categoryName: "Pizze Gourmet", name: "Sole Giallo", desc: "Personale / Familiare / Integrale", price: 10.50 },
                    { id: 66, categoryName: "Pizze Gourmet", name: "Porcini Mushroom", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 67, categoryName: "Pizze Gourmet", name: "Wall Street Pizza", desc: "Personale / Familiare / Integrale", price: 11.00 },
                    { id: 68, categoryName: "Pizze Gourmet", name: "Murtade‚Äô", desc: "Personale / Familiare / Gluten free / Integrale", price: 10.00 },
                    { id: 69, categoryName: "Pizze Gourmet", name: "Lady Brown Pizza", desc: "Personale / Familiare / Gluten free / Integrale", price: 12.00 }
                ]
            },
            {
                id: "pizze-senza-glutine",
                category: "Pizze Senza Glutine",
                items: [
                    { id: 70, categoryName: "Pizze Senza Glutine", name: "Naples", desc: "", price: 9.00 },
                    { id: 71, categoryName: "Pizze Senza Glutine", name: "Sicilian in New Jersey", desc: "", price: 11.00 },
                    { id: 72, categoryName: "Pizze Senza Glutine", name: "Aspra Mare", desc: "", price: 10.50 },
                    { id: 73, categoryName: "Pizze Senza Glutine", name: "La Maria", desc: "", price: 12.50 },
                    { id: 74, categoryName: "Pizze Senza Glutine", name: "San Francesco", desc: "", price: 11.50 },
                    { id: 75, categoryName: "Pizze Senza Glutine", name: "Parmigiana", desc: "", price: 10.50 },
                    { id: 76, categoryName: "Pizze Senza Glutine", name: "Brooklyn Original", desc: "", price: 9.50 },
                    { id: 77, categoryName: "Pizze Senza Glutine", name: "Serenata", desc: "", price: 12.50 },
                    { id: 78, categoryName: "Pizze Senza Glutine", name: "Veggy Pizza", desc: "", price: 11.00 },
                    { id: 79, categoryName: "Pizze Senza Glutine", name: "Murtade‚Äô", desc: "", price: 12.50 },
                    { id: 80, categoryName: "Pizze Senza Glutine", name: "4 Gusti", desc: "", price: 10.50 },
                    { id: 81, categoryName: "Pizze Senza Glutine", name: "Diavola", desc: "", price: 9.50 },
                    { id: 82, categoryName: "Pizze Senza Glutine", name: "Only Meat Lover", desc: "", price: 12.50 },
                    { id: 83, categoryName: "Pizze Senza Glutine", name: "Eggplant Parmigiana", desc: "", price: 10.50 },
                    { id: 84, categoryName: "Pizze Senza Glutine", name: "Romana", desc: "", price: 9.50 },
                    { id: 85, categoryName: "Pizze Senza Glutine", name: "Capricciosa", desc: "", price: 11.00 },
                    { id: 86, categoryName: "Pizze Senza Glutine", name: "Malcolm Ave", desc: "", price: 12.50 },
                    { id: 87, categoryName: "Pizze Senza Glutine", name: "Bianca", desc: "", price: 8.00 },
                    { id: 88, categoryName: "Pizze Senza Glutine", name: "GreenField", desc: "", price: 12.50 },
                    { id: 89, categoryName: "Pizze Senza Glutine", name: "4 Cheese", desc: "", price: 10.50 },
                    { id: 90, categoryName: "Pizze Senza Glutine", name: "Don Calogero", desc: "", price: 10.00 },
                    { id: 91, categoryName: "Pizze Senza Glutine", name: "South Beach", desc: "", price: 14.50 },
                    { id: 92, categoryName: "Pizze Senza Glutine", name: "Chicken Caesar Crust", desc: "", price: 11.00 },
                    { id: 93, categoryName: "Pizze Senza Glutine", name: "Bresa Hola Pizza", desc: "", price: 12.50 },
                    { id: 94, categoryName: "Pizze Senza Glutine", name: "Grandma NCY Pizza", desc: "", price: 9.50 },
                    { id: 95, categoryName: "Pizze Senza Glutine", name: "Margherita Classica", desc: "", price: 8.00 }
                ]
            },
            {
                id: "calzoni",
                category: "Calzoni",
                items: [
                    { id: 96, categoryName: "Calzoni", name: "Ham & Cheese Calzone", desc: "", price: 7.50 },
                    { id: 97, categoryName: "Calzoni", name: "BBQ Chicken Calzone", desc: "", price: 8.50 },
                    { id: 98, categoryName: "Calzoni", name: "Buffalo Chicken Calzone", desc: "", price: 8.50 },
                    { id: 99, categoryName: "Calzoni", name: "Veggie Calzone", desc: "", price: 8.50 },
                    { id: 100, categoryName: "Calzoni", name: "Hot Boy Calzone", desc: "", price: 9.00 }
                ]
            },
            {
                id: "appetizers",
                category: "Appetizers",
                items: [
                    { id: 101, categoryName: "Appetizers", name: "Chicken Nuggets", desc: "8 pezzi", price: 6.00 },
                    { id: 102, categoryName: "Appetizers", name: "Jalape√±os Red Hot", desc: "6 pezzi", price: 6.50 },
                    { id: 103, categoryName: "Appetizers", name: "Pizza Fries", desc: "", price: 6.00 },
                    { id: 104, categoryName: "Appetizers", name: "Crazy Fries", desc: "", price: 7.00 },
                    { id: 105, categoryName: "Appetizers", name: "Mozzarella Sticks", desc: "6 pezzi", price: 5.00 },
                    { id: 106, categoryName: "Appetizers", name: "Seasoned Fries (spicchi spicy)", desc: "1 pezzo / 2 pezzi", price: 3.50 },
                    { id: 107, categoryName: "Appetizers", name: "Cheese Fries", desc: "", price: 4.50 },
                    { id: 108, categoryName: "Appetizers", name: "French Fries", desc: "1 pezzo / 2 pezzi", price: 2.00 },
                    { id: 109, categoryName: "Appetizers", name: "Combo Platter", desc: "", price: 7.00 },
                    { id: 110, categoryName: "Appetizers", name: "Onion Rings", desc: "", price: 4.00 },
                    { id: 111, categoryName: "Appetizers", name: "Chicken Wings", desc: "6 pezzi", price: 6.00 },
                    { id: 112, categoryName: "Appetizers", name: "Patate Surecrisp Fry‚Äôn Dip con Buccia", desc: "", price: 4.00 },
                    { id: 113, categoryName: "Appetizers", name: "Chicken Fingers", desc: "8 pezzi", price: 6.50 },
                    { id: 114, categoryName: "Appetizers", name: "Sweet Potato Fries", desc: "", price: 5.50 },
                    { id: 115, categoryName: "Appetizers", name: "Wurstel alla Griglia", desc: "", price: 5.00 },
                    { id: 116, categoryName: "Appetizers", name: "Crostini di Tuma Fritta", desc: "6 pezzi", price: 6.50 },
                    { id: 117, categoryName: "Appetizers", name: "Misto Caldo", desc: "", price: 6.00 },
                    { id: 118, categoryName: "Appetizers", name: "Curly Fries", desc: "", price: 5.00 },
                    { id: 119, categoryName: "Appetizers", name: "Franky Fries", desc: "", price: 6.00 }
                ]
            },
            {
                id: "insalate",
                category: "Insalate",
                items: [
                    { id: 120, categoryName: "Insalate", name: "Burger Salad", desc: "", price: 12.50 },
                    { id: 121, categoryName: "Insalate", name: "Cesar Palace Salad", desc: "", price: 12.50 },
                    { id: 122, categoryName: "Insalate", name: "Los Angeles Salad", desc: "", price: 14.00 },
                    { id: 123, categoryName: "Insalate", name: "Finest Salad", desc: "", price: 14.00 },
                    { id: 124, categoryName: "Insalate", name: "Midland Salad", desc: "", price: 12.50 },
                    { id: 125, categoryName: "Insalate", name: "Crispy Salad", desc: "", price: 14.00 }
                ]
            },
            {
                id: "mini-burgers",
                category: "Mini Burgers",
                items: [
                    { id: 126, categoryName: "Mini Burgers", name: "Mini Chicken 2", desc: "", price: 2.50 },
                    { id: 127, categoryName: "Mini Burgers", name: "Mini Burger 1", desc: "", price: 2.00 },
                    { id: 128, categoryName: "Mini Burgers", name: "Mini Chicken 1", desc: "", price: 2.00 },
                    { id: 129, categoryName: "Mini Burgers", name: "Mini Burger 2", desc: "", price: 2.50 }
                ]
            },
            {
                id: "american-hamburger",
                category: "American Hamburger",
                items: [
                    { id: 130, categoryName: "American Hamburger", name: "Drive in Burger", desc: "", price: 9.50 },
                    { id: 131, categoryName: "American Hamburger", name: "Pistacchino Burger", desc: "", price: 13.00 },
                    { id: 132, categoryName: "American Hamburger", name: "Country Burger", desc: "", price: 10.50 },
                    { id: 133, categoryName: "American Hamburger", name: "Greta Burger", desc: "", price: 10.00 },
                    { id: 134, categoryName: "American Hamburger", name: "Fat Bastard Burger", desc: "", price: 13.00 },
                    { id: 135, categoryName: "American Hamburger", name: "GB Style Burger", desc: "", price: 9.00 },
                    { id: 136, categoryName: "American Hamburger", name: "The Lo Galbo‚Äôs Burger", desc: "", price: 8.00 },
                    { id: 137, categoryName: "American Hamburger", name: "Jersey Boy Burger", desc: "", price: 9.00 },
                    { id: 138, categoryName: "American Hamburger", name: "Sinaloa Mexico Burger", desc: "", price: 9.50 },
                    { id: 139, categoryName: "American Hamburger", name: "Good Fellas Burger", desc: "", price: 8.50 },
                    { id: 140, categoryName: "American Hamburger", name: "N‚Äôfarinati Original Burger", desc: "", price: 10.00 },
                    { id: 141, categoryName: "American Hamburger", name: "New York Times Burger", desc: "", price: 9.00 }
                ]
            },
            {
                id: "panini-americani",
                category: "Panini Americani",
                items: [
                    { id: 142, categoryName: "Panini Americani", name: "Chicken BLT American Classic", desc: "", price: 8.00 },
                    { id: 143, categoryName: "Panini Americani", name: "California Chicken American Classic", desc: "", price: 8.00 },
                    { id: 144, categoryName: "Panini Americani", name: "Grilled Chicken", desc: "", price: 9.50 },
                    { id: 145, categoryName: "Panini Americani", name: "Heavy Hitter Piccante", desc: "", price: 10.50 },
                    { id: 146, categoryName: "Panini Americani", name: "Italian Hot Dog Italo Americano", desc: "", price: 7.00 },
                    { id: 147, categoryName: "Panini Americani", name: "Hot Dog Maxi", desc: "", price: 6.00 },
                    { id: 148, categoryName: "Panini Americani", name: "Chicken Bacon Ranch Most Loved Sandwich", desc: "", price: 9.00 },
                    { id: 149, categoryName: "Panini Americani", name: "Chicken Parm American Finest", desc: "", price: 8.00 },
                    { id: 150, categoryName: "Panini Americani", name: "Fat Bastard Per i Pi√π Giovani", desc: "", price: 11.00 },
                    { id: 151, categoryName: "Panini Americani", name: "Cardiac Arrest Per i Pi√π Giovani", desc: "", price: 11.00 }
                ]
            },
            {
                id: "philly-style-cheesesteaks",
                category: "Philly Style Cheesesteaks",
                items: [
                    { id: 152, categoryName: "Philly Style Cheesesteaks", name: "Bacon Ranch", desc: "", price: 9.50 },
                    { id: 153, categoryName: "Philly Style Cheesesteaks", name: "Southern Style", desc: "", price: 9.50 },
                    { id: 154, categoryName: "Philly Style Cheesesteaks", name: "Original Philly Sandwich", desc: "", price: 9.00 },
                    { id: 155, categoryName: "Philly Style Cheesesteaks", name: "Cheesesteak on Steroids", desc: "", price: 9.50 },
                    { id: 156, categoryName: "Philly Style Cheesesteaks", name: "California Style", desc: "", price: 9.00 },
                    { id: 157, categoryName: "Philly Style Cheesesteaks", name: "‚ÄôNfari Steak Sandwich", desc: "", price: 9.50 },
                    { id: 158, categoryName: "Philly Style Cheesesteaks", name: "Devil Melt", desc: "", price: 9.50 },
                    { id: 159, categoryName: "Philly Style Cheesesteaks", name: "Cheesesteak", desc: "", price: 8.50 }
                ]
            },
            {
                id: "panini-piastrati",
                category: "Panini Piastrati",
                items: [
                    { id: 160, categoryName: "Panini Piastrati", name: "Panino Piccantino", desc: "", price: 7.50 },
                    { id: 161, categoryName: "Panini Piastrati", name: "Panino ‚ÄôNfarinati Special", desc: "", price: 8.50 },
                    { id: 162, categoryName: "Panini Piastrati", name: "Panino Cartoccio", desc: "salsa a scelta", price: 5.00 },
                    { id: 163, categoryName: "Panini Piastrati", name: "Sofisticato", desc: "", price: 8.50 },
                    { id: 164, categoryName: "Panini Piastrati", name: "Panino Alessio Player", desc: "", price: 5.00 },
                    { id: 165, categoryName: "Panini Piastrati", name: "Panino Tonno e Cipolla", desc: "", price: 7.00 },
                    { id: 166, categoryName: "Panini Piastrati", name: "Panino Bresa Hola", desc: "", price: 8.50 },
                    { id: 167, categoryName: "Panini Piastrati", name: "Panino San Daniele", desc: "", price: 8.00 },
                    { id: 168, categoryName: "Panini Piastrati", name: "Panino Topolino", desc: "salsa a scelta", price: 5.50 }
                ]
            },
            {
                id: "wrap",
                category: "Wrap",
                items: [
                    { id: 169, categoryName: "Wrap", name: "Pump It Up Wrap", desc: "", price: 8.00 },
                    { id: 170, categoryName: "Wrap", name: "Burger Wrap", desc: "", price: 10.50 },
                    { id: 171, categoryName: "Wrap", name: "NY Giants Wrap", desc: "", price: 9.00 },
                    { id: 172, categoryName: "Wrap", name: "Chicken Quesadillas Wrap", desc: "", price: 8.00 },
                    { id: 173, categoryName: "Wrap", name: "Hip Hop Wrap", desc: "", price: 10.00 },
                    { id: 174, categoryName: "Wrap", name: "Buffalo Style Wrap", desc: "", price: 8.50 },
                    { id: 175, categoryName: "Wrap", name: "Chicken Chips Wrap", desc: "", price: 9.50 },
                    { id: 176, categoryName: "Wrap", name: "West Palm Beach Wrap", desc: "", price: 9.00 },
                    { id: 177, categoryName: "Wrap", name: "Baby Wrap", desc: "", price: 6.50 },
                    { id: 178, categoryName: "Wrap", name: "High Class Wrap", desc: "", price: 8.50 },
                    { id: 179, categoryName: "Wrap", name: "Chicago Wrap", desc: "", price: 9.50 },
                    { id: 180, categoryName: "Wrap", name: "BBQ Chicken Wrap", desc: "", price: 8.50 },
                    { id: 181, categoryName: "Wrap", name: "Belmar Wrap", desc: "", price: 11.00 },
                    { id: 182, categoryName: "Wrap", name: "Chicken Caesar Wrap", desc: "", price: 7.50 },
                    { id: 183, categoryName: "Wrap", name: "Tom‚Äôs River Wraps", desc: "", price: 10.50 }
                ]
            },
            {
                id: "specialita",
                category: "Specialit√†",
                items: [
                    { id: 184, categoryName: "Specialit√†", name: "Family Style", desc: "Per Uno / Per Tre", price: 8.00 },
                    { id: 185, categoryName: "Specialit√†", name: "Cool Ranch", desc: "Per Uno / Per Tre", price: 8.50 },
                    { id: 186, categoryName: "Specialit√†", name: "Mr Potato", desc: "Per Uno / Per Tre", price: 8.50 },
                    { id: 187, categoryName: "Specialit√†", name: "American Classic", desc: "Per Uno / Per Tre", price: 7.50 }
                ]
            },
            {
                id: "pizze-dessert",
                category: "Pizze Dessert",
                items: [
                    { id: 188, categoryName: "Pizze Dessert", name: "Oreos Pizza", desc: "Personale / Familiare", price: 8.00 },
                    { id: 189, categoryName: "Pizze Dessert", name: "Nutella‚Äôs", desc: "Personale / Familiare", price: 6.50 },
                    { id: 190, categoryName: "Pizze Dessert", name: "Green Love", desc: "Personale / Familiare", price: 8.00 },
                    { id: 191, categoryName: "Pizze Dessert", name: "Black and White", desc: "Personale / Familiare", price: 8.00 }
                ]
            },
            {
                id: "bevande",
                category: "Bevande",
                items: [
                    { id: 192, categoryName: "Bevande", name: "Coca-Cola Original Taste PET 1,5 L", desc: "", price: 3.50 },
                    { id: 193, categoryName: "Bevande", name: "Sprite PET 1,5 L", desc: "", price: 3.50 },
                    { id: 194, categoryName: "Bevande", name: "Sprite Sleek Can 330 ml", desc: "", price: 2.50 },
                    { id: 195, categoryName: "Bevande", name: "Coca-Cola Sleek 33cl", desc: "", price: 2.50 },
                    { id: 196, categoryName: "Bevande", name: "Acqua Naturale 50cl", desc: "", price: 1.50 },
                    { id: 197, categoryName: "Bevande", name: "Bibita in Lattina 33cl Chinotto", desc: "", price: 2.50 },
                    { id: 198, categoryName: "Bevande", name: "Bibita in Lattina 33cl T√® al Limone", desc: "", price: 2.50 },
                    { id: 199, categoryName: "Bevande", name: "Bibita in Lattina 33cl T√® alla Pesca", desc: "", price: 2.50 },
                    { id: 200, categoryName: "Bevande", name: "Fanta Original Sleek 33 cl", desc: "", price: 2.50 }
                ]
            },
            {
                id: "birre",
                category: "Birre",
                items: [
                    { id: 201, categoryName: "Birre", name: "Birra 33cl Heineken", desc: "", price: 3.00 },
                    { id: 202, categoryName: "Birre", name: "Birra 33cl Ceres", desc: "", price: 4.00 },
                    { id: 203, categoryName: "Birre", name: "Birra 33cl Ichnusa", desc: "", price: 4.00 },
                    { id: 204, categoryName: "Birre", name: "Birra 33cl Beck‚Äôs 33cl", desc: "", price: 3.00 },
                    { id: 205, categoryName: "Birre", name: "Heineken 66cl", desc: "", price: 3.50 },
                    { id: 206, categoryName: "Birre", name: "Moretti 66cl", desc: "", price: 3.50 }
                ]
            }
        ];

        let cart = {};
        let itemMap = {};
        let currentModalState = { itemId: null, selections: {} };

        function buildItemMap() {
            menuData.forEach(cat => cat.items.forEach(i => {
                i.categoryId = cat.id; 
                itemMap[i.id] = i;
            }));
        }

        function initApp() { 
            buildItemMap();
            renderFilters(); 
            renderMenu(); 
        }

        function renderFilters() {
            const filterContainer = document.getElementById('filters-container');
            const btnAll = document.createElement('button'); btnAll.className = 'filter-btn active'; btnAll.innerText = 'Tutti';
            btnAll.onclick = () => filterMenu('all', btnAll); filterContainer.appendChild(btnAll);
            menuData.forEach(cat => {
                const btn = document.createElement('button'); btn.className = 'filter-btn'; btn.innerText = cat.category;
                btn.onclick = () => filterMenu(cat.id, btn); filterContainer.appendChild(btn);
            });
        }

        function filterMenu(categoryId, btnElement) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); btnElement.classList.add('active');
            document.querySelectorAll('.category-section').forEach(section => {
                if (categoryId === 'all' || section.id === `cat-${categoryId}`) section.classList.remove('hidden'); else section.classList.add('hidden');
            });
            window.scrollTo({ top: document.getElementById('filters-container').offsetTop - 20, behavior: 'smooth' });
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            menuData.forEach(category => {
                const sectionDiv = document.createElement('div'); sectionDiv.className = 'category-section'; sectionDiv.id = `cat-${category.id}`;
                sectionDiv.innerHTML = `<h2 class="category-title">${category.category}</h2>`;
                category.items.forEach(item => {
                    
                    let isPizza = item.categoryName.toLowerCase().includes('pizz') && item.categoryName !== 'Pizze Senza Glutine';
                    let isBurger = item.categoryName.toLowerCase().includes('burger');
                    
                    let displayPrice = (isPizza || isBurger) ? `da ${item.price.toFixed(2).replace('.',',')}‚Ç¨` : `${item.price.toFixed(2).replace('.',',')}‚Ç¨`;

                    sectionDiv.innerHTML += `
                        <div class="menu-item">
                            <div class="item-header"><div class="item-name">${item.name}</div><div class="item-price">${displayPrice}</div></div>
                            <p class="item-desc">${item.desc || ''}</p>
                            <div class="controls">
                                <div style="flex-grow: 1;"></div>
                                <div class="qty-box">
                                    <button class="btn-control" onclick="handleRemoveClick(${item.id})"><i class="fa-solid fa-minus"></i></button>
                                    <span class="qty" id="qty-${item.id}">0</span>
                                    <button class="btn-control" onclick="handleAddClick(${item.id})"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                            <div id="variants-${item.id}"></div>
                        </div>`;
                });
                container.appendChild(sectionDiv);
            });
        }

        function handleAddClick(id) {
            const item = itemMap[id];
            let catName = item.categoryName.toLowerCase();
            
            if (catName.includes('pizz') || catName.includes('burger')) {
                openCustomModal(id);
            } else {
                updateQty(id, 1);
            }
        }

        function handleRemoveClick(id) {
            const item = itemMap[id];
            let baseCount = cart[id] || 0;
            let variantsInCart = Object.keys(cart).filter(k => k.startsWith('c_' + id + '_') && cart[k] > 0);
            
            let isPizzaOrBurger = item.categoryName.toLowerCase().includes('pizz') || item.categoryName.toLowerCase().includes('burger');
            
            if (isPizzaOrBurger) {
                if (variantsInCart.length === 1) {
                    updateQty(variantsInCart[0], -1);
                } else if (variantsInCart.length > 1) {
                    alert("Hai diverse varianti nel carrello. Usa i tasti '-' delle singole varianti qui sotto per rimuoverle.");
                }
            } else {
                if (baseCount > 0) {
                    updateQty(id, -1);
                } else if (variantsInCart.length === 1) {
                    updateQty(variantsInCart[0], -1);
                } else if (variantsInCart.length > 1) {
                    alert("Hai diverse varianti nel carrello. Usa i tasti '-' delle singole varianti qui sotto.");
                }
            }
        }

        function openCustomModal(id) {
            const item = itemMap[id];
            document.getElementById('custom-title').innerText = item.name;
            
            currentModalState = {
                itemId: id,
                selections: {}
            };

            if (item.categoryName === 'Pizze Senza Glutine') {
                currentModalState.selections['impasto'] = 'Senza Glutine';
            }

            renderModalContent();
            document.getElementById('custom-modal').classList.add('active');
        }

        function renderModalContent() {
            const item = itemMap[currentModalState.itemId];
            const container = document.getElementById('custom-dynamic-sections');
            let html = '';

            let isPizza = item.categoryName.toLowerCase().includes('pizz');
            let isSenzaGlutine = item.categoryName === 'Pizze Senza Glutine';
            let isBurger = item.categoryName.toLowerCase().includes('burger');

            if (isPizza && !isSenzaGlutine) {
                html += `<div class="custom-section-title">Variante <span class="badge-req">Obbligatorio</span></div><div class="custom-group">`;
                [{name: 'Normale', price: 0}, {name: 'Maxi', price: 5.00}].forEach(opt => {
                    const isChecked = currentModalState.selections['variante'] === opt.name ? 'checked' : '';
                    let pText = opt.price > 0 ? `+${opt.price.toFixed(2)}‚Ç¨` : '+0.00‚Ç¨';
                    html += `
                        <label class="custom-option-card ${isChecked ? 'selected' : ''}">
                            <div class="custom-option-left">
                                <input type="radio" name="variante" value="${opt.name}" ${isChecked} onchange="updateModalState('variante', '${opt.name}')"> ${opt.name}
                            </div>
                            <span class="custom-price">${pText}</span>
                        </label>`;
                });
                html += `</div>`;
            }

            if (isPizza && !isSenzaGlutine && currentModalState.selections['variante']) {
                html += `<div class="custom-section-title">Scegli l'Impasto <span class="badge-req">Obbligatorio</span></div><div class="custom-group">`;
                let impasti = [{name: 'Impasto Classico', price: 0}];
                
                if (currentModalState.selections['variante'] === 'Normale') {
                    impasti.push({name: 'Integrale ai semi misti', price: 2.00});
                    impasti.push({name: 'Bordo Ripieno Classico', price: 2.50});
                    impasti.push({name: 'Senza Glutine', price: 3.00});
                }

                impasti.forEach(opt => {
                    const isChecked = currentModalState.selections['impasto'] === opt.name ? 'checked' : '';
                    let pText = opt.price > 0 ? `+${opt.price.toFixed(2)}‚Ç¨` : '+0.00‚Ç¨';
                    html += `
                        <label class="custom-option-card ${isChecked ? 'selected' : ''}">
                            <div class="custom-option-left">
                                <input type="radio" name="impasto" value="${opt.name}" ${isChecked} onchange="updateModalState('impasto', '${opt.name}')"> ${opt.name}
                            </div>
                            <span class="custom-price">${pText}</span>
                        </label>`;
                });
                html += `</div>`;
            }

            if (isBurger) {
                html += `<div class="custom-section-title">Cottura Carne <span class="badge-req">Obbligatorio</span></div><div class="custom-group">`;
                [{name: 'Ben Cotta'}, {name: 'Media'}, {name: 'Al Sangue'}].forEach(opt => {
                    const isChecked = currentModalState.selections['cottura'] === opt.name ? 'checked' : '';
                    html += `
                        <label class="custom-option-card ${isChecked ? 'selected' : ''}">
                            <div class="custom-option-left">
                                <input type="radio" name="cottura" value="${opt.name}" ${isChecked} onchange="updateModalState('cottura', '${opt.name}')"> ${opt.name}
                            </div>
                        </label>`;
                });
                html += `</div>`;
            }

            container.innerHTML = html;
            validateAndCalculatePrice();
        }

        function updateModalState(groupName, value) {
            currentModalState.selections[groupName] = value;
            
            if (groupName === 'variante' && value === 'Maxi' && currentModalState.selections['impasto'] && currentModalState.selections['impasto'] !== 'Impasto Classico') {
                currentModalState.selections['impasto'] = null;
            }
            
            renderModalContent(); 
        }

        function validateAndCalculatePrice() {
            const item = itemMap[currentModalState.itemId];
            let isPizza = item.categoryName.toLowerCase().includes('pizz');
            let isSenzaGlutine = item.categoryName === 'Pizze Senza Glutine';
            let isBurger = item.categoryName.toLowerCase().includes('burger');
            
            let extraPrice = 0;
            let isValid = true;

            if (isPizza && !isSenzaGlutine) {
                if (!currentModalState.selections['variante']) isValid = false;
                if (!currentModalState.selections['impasto']) isValid = false;
            }
            if (isBurger) {
                if (!currentModalState.selections['cottura']) isValid = false;
            }

            if (currentModalState.selections['variante'] === 'Maxi') extraPrice += 5.00;
            if (currentModalState.selections['impasto'] === 'Bordo Ripieno Classico') extraPrice += 2.50;
            if (currentModalState.selections['impasto'] === 'Integrale ai semi misti') extraPrice += 2.00;
            if (currentModalState.selections['impasto'] === 'Senza Glutine' && !isSenzaGlutine) extraPrice += 3.00;

            let newPrice = item.price + extraPrice;
            const btn = document.getElementById('btn-add-custom');
            
            if (!isValid) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Scegli le opzioni obbligatorie';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus"></i> Aggiungi a ' + newPrice.toFixed(2).replace('.',',') + '‚Ç¨';
            }
        }

        function closeCustomModal() {
            document.getElementById('custom-modal').classList.remove('active');
            currentModalState = { itemId: null, selections: {} };
        }

        function addCustomItemToCart() {
            const item = itemMap[currentModalState.itemId];
            let extraPrice = 0;
            let customParts = [];
            
            let isSenzaGlutine = item.categoryName === 'Pizze Senza Glutine';

            if (currentModalState.selections['variante'] && currentModalState.selections['variante'] !== 'Normale') {
                customParts.push(currentModalState.selections['variante']);
                extraPrice += 5.00;
            }
            if (currentModalState.selections['impasto'] && currentModalState.selections['impasto'] !== 'Impasto Classico') {
                if(!isSenzaGlutine) customParts.push(currentModalState.selections['impasto']);
                
                if (currentModalState.selections['impasto'] === 'Bordo Ripieno Classico') extraPrice += 2.50;
                if (currentModalState.selections['impasto'] === 'Integrale ai semi misti') extraPrice += 2.00;
                if (currentModalState.selections['impasto'] === 'Senza Glutine' && !isSenzaGlutine) extraPrice += 3.00;
            }
            if (currentModalState.selections['cottura']) {
                customParts.push(currentModalState.selections['cottura']);
            }

            if (customParts.length === 0) {
                updateQty(currentModalState.itemId, 1);
                closeCustomModal();
                return;
            }

            let newPrice = item.price + extraPrice;
            let signature = `${item.id}|${customParts.sort().join('|')}`;
            
            let hash = 0; 
            for (let i = 0; i < signature.length; i++) hash = Math.imul(31, hash) + signature.charCodeAt(i) | 0;
            let customId = "c_" + item.id + "_" + Math.abs(hash);

            if (!itemMap[customId]) {
                itemMap[customId] = { 
                    id: customId, baseId: item.id, name: item.name, price: newPrice, isCustom: true, 
                    customParts: customParts
                };
                
                let variantHtml = `
                    <div class="variant-item" id="variant-${customId}">
                        <div class="variant-header">
                            <span>Variante (${newPrice.toFixed(2).replace('.',',')}‚Ç¨)</span>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <button class="btn-control" style="width:26px;height:26px; border-color:var(--accent-main); color:var(--accent-main);" onclick="updateQty('${customId}', -1)"><i class="fa-solid fa-minus" style="font-size:0.8rem;"></i></button>
                                <span class="qty" style="font-size:1rem; min-width:20px; color:var(--text-dark);" id="qty-${customId}">0</span>
                                <button class="btn-control" style="width:26px;height:26px; border-color:var(--accent-main); color:var(--accent-main);" onclick="updateQty('${customId}', 1)"><i class="fa-solid fa-plus" style="font-size:0.8rem;"></i></button>
                            </div>
                        </div>
                        <div class="variant-desc">
                            ${customParts.join(' | ')}
                        </div>
                    </div>
                `;
                document.getElementById(`variants-${item.id}`).insertAdjacentHTML('beforeend', variantHtml);
            }

            updateQty(customId, 1);
            closeCustomModal();
        }

        function updateQty(itemId, change) {
            if (!cart[itemId]) cart[itemId] = 0; 
            cart[itemId] += change; 
            if (cart[itemId] < 0) cart[itemId] = 0;
            
            if (itemMap[itemId] && itemMap[itemId].isCustom) {
                if (cart[itemId] <= 0) {
                    document.getElementById(`variant-${itemId}`).style.display = 'none';
                } else {
                    document.getElementById(`variant-${itemId}`).style.display = 'block';
                }
                let qtySpan = document.getElementById(`qty-${itemId}`);
                if(qtySpan) qtySpan.innerText = cart[itemId];
                
                updateBaseItemQty(itemMap[itemId].baseId);
            } else {
                let qtySpan = document.getElementById(`qty-${itemId}`);
                if(qtySpan) qtySpan.innerText = cart[itemId];
                updateBaseItemQty(itemId);
            }
            
            updateCartUI();
        }

        function updateBaseItemQty(baseId) {
            let total = cart[baseId] || 0;
            for(let id in cart) {
                if(cart[id] > 0 && itemMap[id] && itemMap[id].isCustom && itemMap[id].baseId == baseId) {
                    total += cart[id];
                }
            }
            let baseQtySpan = document.getElementById(`qty-${baseId}`);
            if(baseQtySpan) baseQtySpan.innerText = total;
        }

        function updateCartUI() {
            let total = 0, totalItems = 0;
            for(let id in cart) {
                if (cart[id] > 0 && itemMap[id]) {
                    total += itemMap[id].price * cart[id]; 
                    totalItems += cart[id];
                }
            }

            // CALCOLO SCONTO DEL 10%
            let sconto = total * 0.10;
            let finalTotal = total - sconto;

            // Aggiorna Carrello Footer (con prezzo barrato e nuovo prezzo)
            let priceHtml = "0,00 ‚Ç¨";
            if (total > 0) {
                priceHtml = `
                    <span class="old-price-strike">${total.toFixed(2).replace('.',',')} ‚Ç¨</span>
                    <span>${finalTotal.toFixed(2).replace('.',',')} ‚Ç¨ <span class="discount-badge">-10%</span></span>
                `;
            }
            document.getElementById('total-price').innerHTML = priceHtml;

            const footer = document.getElementById('cart-footer');
            if (totalItems > 0) footer.classList.add('visible'); else footer.classList.remove('visible');

            // Aggiorna riepilogo nel checkout
            updateCheckoutSummary(total, sconto, finalTotal);
        }

        function updateCheckoutSummary(subtotale, sconto, totaleFinale) {
            const summaryContainer = document.getElementById('order-summary-breakdown');
            if(summaryContainer) {
                if(subtotale > 0) {
                    summaryContainer.style.display = 'block';
                    summaryContainer.innerHTML = `
                        <div class="summary-line"><span>Subtotale:</span> <span>${subtotale.toFixed(2).replace('.',',')} ‚Ç¨</span></div>
                        <div class="summary-line discount-line"><span>Sconto Speciale (10%):</span> <span>- ${sconto.toFixed(2).replace('.',',')} ‚Ç¨</span></div>
                        <div class="summary-line total-line"><span>Totale da Pagare:</span> <span>${totaleFinale.toFixed(2).replace('.',',')} ‚Ç¨</span></div>
                    `;
                } else {
                    summaryContainer.style.display = 'none';
                }
            }
        }

        function popolaOrari() {
            const select = document.getElementById('orario-consegna');
            const payBtn = document.getElementById('pay-btn');
            select.innerHTML = '';
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const minTimeInMinutes = (currentHour * 60) + currentMinute + 20;

            let slotAggiunti = 0;
            for(let h = 18; h <= 23; h++) {
                for(let m = 0; m < 60; m += 15) {
                    if (h === 18 && m < 30) continue; 
                    if (h === 23 && m > 30) continue; 
                    
                    const slotTimeInMinutes = (h * 60) + m;
                    if (slotTimeInMinutes >= minTimeInMinutes || currentHour < 18) {
                        let hh = h.toString().padStart(2, '0');
                        let mm = m.toString().padStart(2, '0');
                        select.innerHTML += `<option value="${hh}:${mm}">${hh}:${mm}</option>`;
                        slotAggiunti++;
                    }
                }
            }

            if (slotAggiunti === 0) {
                select.innerHTML = `<option value="">Orari esauriti per oggi</option>`;
                payBtn.disabled = true;
                payBtn.style.boxShadow = 'none';
            } else {
                payBtn.disabled = false;
                payBtn.style.boxShadow = '0 4px 15px rgba(211, 47, 47, 0.3)';
            }
        }

        function toggleOrderType() {
            const type = document.querySelector('input[name="order-type"]:checked').value;
            const labelOrario = document.getElementById('orario-label');
            
            if(type === 'takeaway') {
                document.getElementById('lbl-takeaway').classList.add('active');
                document.getElementById('lbl-delivery').classList.remove('active');
                document.getElementById('delivery-fields').style.display = 'none';
                labelOrario.innerText = "Orario di Ritiro *";
            } else {
                document.getElementById('lbl-takeaway').classList.remove('active');
                document.getElementById('lbl-delivery').classList.add('active');
                document.getElementById('delivery-fields').style.display = 'block';
                labelOrario.innerText = "Orario di Consegna *";
            }
        }

        function openCheckout() { 
            document.getElementById('checkout-modal').classList.add('active'); 
            popolaOrari();
            // Forza aggiornamento riepilogo prezzi quando si apre il modale
            updateCartUI(); 
        }

        function closeCheckout() {
            document.getElementById('checkout-modal').classList.remove('active');
        }

        function cambiaBottonePagamento() {
            const metodo = document.getElementById('metodo-pagamento').value;
            const btn = document.getElementById('pay-btn');
            if (metodo === 'contanti') {
                btn.innerHTML = '<i class="fa-solid fa-check-to-slot"></i> Conferma Ordine';
                btn.style.background = '#28a745';
                btn.style.boxShadow = '0 4px 15px rgba(40, 167, 69, 0.3)';
            } else {
                btn.innerHTML = '<i class="fa-regular fa-credit-card"></i> Paga con Nexi';
                btn.style.background = 'var(--accent-main)';
                btn.style.boxShadow = '0 4px 15px rgba(211, 47, 47, 0.3)';
            }
        }

        async function sendOrderWithDetails() {
            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const orderType = document.querySelector('input[name="order-type"]:checked').value;
            const notes = document.getElementById('cust-notes').value.trim();
            const orario = document.getElementById('orario-consegna').value;
            const metodoPagamento = document.getElementById('metodo-pagamento').value;

            if(!name || !phone) { alert("Compila Nome e Telefono per continuare!"); return; }

            let deliveryInfo = "";
            if (orderType === 'delivery') {
                const address = document.getElementById('cust-address').value.trim();
                if(!address) { alert("Inserisci l'indirizzo di consegna."); return; }
                deliveryInfo = `üõµ *Consegna a Domicilio*%0Aüìç Indirizzo: ${address}%0Aüïí Orario Richiesto: ${orario}`;
            } else {
                deliveryInfo = `üõçÔ∏è *Ritiro al Locale*%0Aüïí Orario Richiesto: ${orario}`;
            }

            const cleanName = name.replace(/\s+/g, '').toUpperCase(); 
            const firstLetter = cleanName.charAt(0) || 'N';
            const lastLetter = cleanName.charAt(cleanName.length - 1) || 'F';
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            
            const orderId = `NFAR-${firstLetter}${lastLetter}-${randomNum}_${orario}`;

            let total = 0; 
            let text = `üÜî *Rif:* ${orderId}%0A%0Aüë§ *Cliente:* ${name}%0Aüì± *Telefono:* ${phone}%0A${deliveryInfo}%0A`;
            if(notes) text += `üìù *Note:* ${notes}%0A`; 
            text += `%0A*RIEPILOGO ORDINE:*%0A`;

            for(let id in cart) {
                if (cart[id] > 0 && itemMap[id]) {
                    let item = itemMap[id];
                    const lineTotal = item.price * cart[id]; 
                    total += lineTotal;
                    
                    let customTesto = "";
                    if(item.isCustom && item.customParts) {
                        customTesto += `%0A   ‚Ü≥ ${item.customParts.join(' | ')}`;
                    }
                    
                    text += `‚ñ´Ô∏è ${cart[id]}x ${item.name} (${lineTotal.toFixed(2)}‚Ç¨)${customTesto}%0A`;
                }
            }

            // Calcolo Sconto e Prezzo Finale per WhatsApp / Nexi
            let sconto = total * 0.10;
            let finalTotal = total - sconto;

            if (finalTotal < 1.00) { alert("L'ordine minimo √® 1.00 ‚Ç¨!"); return; }

            text += `%0Aüìâ *Subtotale:* ${total.toFixed(2)} ‚Ç¨`;
            text += `%0Aüéâ *Sconto Speciale 10%:* -${sconto.toFixed(2)} ‚Ç¨`;
            text += `%0Aüí∞ *TOTALE DA PAGARE: ${finalTotal.toFixed(2)} ‚Ç¨*%0A`;

            const btn = document.getElementById('pay-btn');

            if (metodoPagamento === "contanti") {
                text = `‚ö†Ô∏è *ORDINE DA PAGARE IN CONTANTI* ‚ö†Ô∏è%0A%0A` + text;
                localStorage.setItem('peterbun_order_message', text);
                window.location.href = "successo.html";
                return;
            }

            text = `‚úÖ *ORDINE PAGATO ONLINE (Nexi)*%0A%0A` + text;
            localStorage.setItem('peterbun_order_message', text);
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Elaborazione...'; 
            btn.disabled = true;

            try {
                // Passiamo finalTotal (il prezzo scontato) al gateway Nexi
                const response = await fetch("/paga", {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId, totalAmount: finalTotal })
                });
                const data = await response.json();
                if (data.success && data.redirectUrl) { 
                    window.location.href = data.redirectUrl;
                } else { 
                    alert("üö´ ATTENZIONE: " + data.error); 
                    cambiaBottonePagamento();
                    btn.disabled = false; 
                }
            } catch (error) {
                alert("Errore di connessione. Riprova tra poco."); 
                cambiaBottonePagamento();
                btn.disabled = false;
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>